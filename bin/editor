#!/usr/bin/env bash

cmd=("$@")

if [[ -z $ALTERNATE_EDITOR ]]
then
  for candidate in emacs vim vi
  do
    if [[ -n $(which $candidate 2>/dev/null) ]]
    then
      export ALTERNATE_EDITOR="${candidate}"
      break
    fi
  done
fi

if [[ -z $(which emacsclient) ]]
then
  "${ALTERNATE_EDITOR}" "${@}"
  exit $?
fi

if [[ -n $SSH_CONNECTION ]]
then
  if [[ -n $REMOTE_EMACS_CLIENT_NAME ]]
  then
    remote_emacs_client_name="${REMOTE_EMACS_CLIENT_NAME}"
  else
    remote_emacs_client_name="$(uname -n)"
  fi

  target="${cmd[$((${#cmd[@]}-1))]}"

  if [[ $target = /* ]]
  then
    target="/ssh:${remote_emacs_client_name}:$target"
  else
    target="/ssh:${remote_emacs_client_name}:${PWD}/${target}"
  fi
  cmd[$((${#cmd[@]}-1))]="${target}"
fi

# I use TCP for the Emacs server, because I also use it remotely
# from other machines
if [[ -f ~/.emacs.d/server/server ]]
then
  cmd+=(-f ~/.emacs.d/server/server)
fi

echo "${cmd[@]}"

emacsclient "${cmd[@]}"
